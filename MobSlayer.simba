{$I WaspLib/osrs.simba}
{$DEFINE WL_DEBUG_UPTEXT}
{$DEFINE WL_DEBUG_MOUSE}

(******************************************************************************
* Project: General Combat Bot
* Author : Jake Lam
* Notes  : Slays any mob. You must setup the Map first
* Steps: Go to https://map.waspscripts.com/
* Grab the Map Chunk value. Lumbridge ex: Map.Setup([Chunk(Box(49,51,51,49), 0)]);
******************************************************************************)

var
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: Fighter Settings
// Please fill out the following variables before starting the bot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  LOGIN_NAME  = 'WashUrRice';     //Username/Email
  LOGIN_PASS  = '@Brad8928828';  //Password
  PPIN        = '';              //Bank pin

  //Mob Name
  mobName     := "Guard";
  food        := "Lobster";
  hpThreshold := 25;
  trainPrayer := true;

  lootList : TStringArray := ['Coins'];
  bankPt  : TPoint := [12676, 36470]; //fill this is with your reset anchor position
  anchorPt   : TPoint := [12852,36578];// bank location

  playerSensedIdling := 15;//seconds
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// script values
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //Login values
  profile : TProfile;

  //Pathfinding
  loot,mob: TRSEntity;
  player    : TPoint;

  //State machine with default values
  Consumer : TRSConsumables;
  isAttacking : boolean := false;

  //Reporting values
  timeElapsed: String;
  timer  : TStopWatch;
  xp: Integer;
  hp : Integer;

  //fail safe
  isPlayerNearby := false;
  MAX_ATTEMPTS := 10;
  PLAYER_INTERFERENCE := 5;


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: Setting up location and pathfinding
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

procedure setupLocation();
begin
   //Map.Setup([ERSChunk.LUMBRIDGE, ERSChunk.AL_KHARID]); //lumbrdige
   Map.Setup([ERSChunk.VARROCK]);//Varrock
end;

procedure navigateToBank();
begin
  Map.Walker.WebWalk(bankPt);
  Bank.Open();
  Bank.DepositInventory();
  Bank.Withdraw(food);
end;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: Profile and time management
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Procedure endScript(Reason: string);
begin
  TerminateScript(Reason);
end;

Procedure setupLogin();
begin
  profile.Name          := LOGIN_NAME;
  profile.Username      := LOGIN_PASS;
  profile.Password      := PPIN;
  Profiles.Add(LOGIN_NAME,LOGIN_PASS,PPIN);
end;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: State Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
procedure checkAreaForPlayers();
begin
  if Chat.FindMessageLine('Someone else is fighting that.') then
  begin
    isPlayerNearby := true;
    Writeln("[" + timeElapsed +"]: There are players in your area. idling for " + toStr(playerSensedIdling) + " seconds");
    Sleep(playerSensedIdling * 1000);
  end;
end;

procedure checkCombatState();
begin
  Sleep(2000);
  xp := XPBar.Read();
  if not XPBar.EarnedXP() then
  begin
    isAttacking := false;
    Writeln("[" + timeElapsed +"]: " + "No longer in combat");
  end
  else
  begin
    isAttacking := true;
    //Writeln("[" + timeElapsed +"]: " + "Currently in combat");
  end;
end;

procedure setupAntiBan();
begin

  Antiban.Skills := [ERSSkill.DEFENCE, ERSSkill.ATTACK, ERSSkill.STRENGTH];
  Antiban.AddTask(@Antiban.SmallRandomMouse,    ONE_MINUTE * 1);
  Antiban.AddTask(@Antiban.RandomRightClick,    ONE_MINUTE * 45);
  Antiban.AddTask(@Antiban.RandomTab,           ONE_MINUTE * 25);
  Antiban.AddTask(@Antiban.SmallCameraRotation, ONE_MINUTE * 11);
  Antiban.AddTask(@Antiban.HoverSkills,         ONE_MINUTE * 5);

  Antiban.AddBreak(ONE_MINUTE*5, ONE_SECOND*40, 0.2, 0.0);   //Short break
  Antiban.AddBreak(ONE_MINUTE*90, ONE_MINUTE*10, 0.2, 0.0);  //Moderate break
  Antiban.DoAntiban();
end;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: Player Interaction
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

//Heal if hp is low
procedure healHP();
begin
    if not Consumables.Has(ERSConsumable.FOOD) then
    begin
      WriteLn("["+timeElapsed+"]: "+'No food found (e.g., Lobster).');
      navigateToBank();
    end;

    hp := Minimap.GetLevel(ERSMinimapOrb.HITPOINTS);
    if hp <= hpThreshold then
    begin
      writeln("["+timeElapsed+"]: "+'HP is low. Eating '+food+" You have: "+toStr(Consumer.Count(ERSConsumable.FOOD)) + " left");
      Consumer.Consume(ERSConsumable.FOOD);
      writeln("[" + timeElapsed +"]: " + 'Current HP: ' + toStr(hp));
    end;
end;

procedure buryBones();
var
  i: Integer;
  boneCount: Integer;
begin
  if trainPrayer then
  begin
    boneCount := Inventory.Items.Count("Bones");
    if boneCount > 0 then
    begin
      writeln("["+timeElapsed+"]: " + "Burying bones ğŸ¦´");
      for i := 0 to boneCount do
      begin
        Inventory.Items.Click("Bones");
        Sleep(1000);
      end;
    end;
  end;
end;

//loot items from players item list
procedure lootItems();
var
  i : Integer;
  atpa:   T2DPointArray;
begin
   Sleep(1000);
   if loot.Find(atpa) then
   begin
    if atpa <> [] then
      Mouse.Move(atpa.Random.Random);
    //ShowOnTarget(loot);
    Sleep(500,1000);
    Mouse.Click(EMouseButton.RIGHT);
    Sleep(1000);
    if ChooseOption.IsOpen() then
    begin
      for i := 0 to High(lootList) do
      begin
        if ChooseOption.Find(lootList) then
        begin
          writeln("["+timeElapsed+"]: "+"Found " + toStr(lootList[i]) + " ğŸ’°");
          Sleep(1000);
          ChooseOption.Select(['Take ' + toStr(lootList[i])]);
          Sleep(2000);
          Mouse.Click(EMouseButton.RIGHT);
        end;
      end;
    end;
    ChooseOption.Close();
   end;
end;

//Get the closest mob and set the target
procedure attackTarget();
var
  atpa:   T2DPointArray;
begin
    Sleep(1500);

    if mob.Find(atpa) then
    begin
        mob.Hover();
        //ShowOnTarget(mob);
        if MainScreen.IsUpText('Attack ' + mobName, False, 0.75, 100) then
        begin
            if not isAttacking then
            begin
              checkAreaForPlayers();
              WriteLn("[" + timeElapsed +"]: "+ 'Found ' + mobName + ', Attacking now âš”ï¸');
              Mouse.Click(EMouseButton.LEFT);
              isAttacking := true;
            end;
        end;
    end;
    Sleep(1500);
end;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: Reporting
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

procedure printProgReport();
begin
  Writeln("");
  Writeln("+ Mob Slayer âš”ï¸  ------------------+");
  Writeln("| Total Time Elapsed:       " + timeElapsed + "  |");
  Writeln("| Bot Time:                 " + toStr(Logger.TimeRunning.ElapsedFmt(TIME_SHORT)) + "  |");
  Writeln("| Antiban Time:             " + toStr(Antiban.TimeRunning.ElapsedFmt(TIME_SHORT)) + "  | ");
  Writeln("+-------------------------------------+");
  Writeln("");
  Writeln("+------------ XP Gained --------------+");
  Writeln("| You have gained: " + toStr(XPBar.TotalEarnedXP) + " XP    ");
  Writeln("| Experience Per Hour: " + toStr((XPBar.TotalEarnedXP/(timer.Elapsed/1000))*3600) + " xp/hr ");
  Writeln("+------------ XP Gained --------------+");
  Writeln("");
end;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Section: Initializing Fighter with settings
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
procedure init();
var
  i: Integer;
begin

  setupLogin();
  if not RSClient.IsLoggedIn then
    Login.DoLogin(profile);

  timeElapsed := toStr(GetTimeStamp(TIME_SHORT));
  timer.Start();
  printProgReport();
  setupAntiBan();

  setupLocation();
  player := Map.Position(); //Player Position
  writeln("[" + timeElapsed +"]: " + "Initializing at Position: " + toStr(Map.Position()));

  loot := TRSEntity.Create(@Map.Walker,[1,1,7],80,[player], ['Bones'], [ERSMinimapDot.Item]);
  mob := TRSEntity.Create(@Map.Walker,[1,1,7],80,[player], [mobName], [ERSMinimapDot.npc]);
  loot.Finder.ColorClusters += [
   [$CCCCD2, 0.492, EColorSpace.LCH, [0.626, 1.188, 1.188]],
   [$C7C4CE, 2.504, EColorSpace.LCH, [0.637, 2.161, 0.203]],8
  ];

  Consumer.Setup();
  Consumer.find(ERSConsumable.FOOD);
  Inventory.Items.Setup('Inventory.Items', @Inventory.Slots, [0, 0], @Inventory.Open);
  Inventory.Open();

  Map.Walker.WalkBlind(anchorPt);
  Writeln("[" + timeElapsed +"]: " + "Walking to anchor coordinate: " + toStr(anchorPt));

  //Begin Loop
  while True do
  begin
    timeElapsed := toStr(GetTimeStamp(TIME_SHORT));
    if not RSClient.IsLoggedIn then
      Login.DoLogin(profile);

    Antiban.DoAntiban();
    Sleep(1500,2000);
    //Removing dialog from chat box
    if Chat.LeveledUp() then
    begin
      Writeln("[" + timeElapsed +"]: " + "Closing chat dialog");
      Chat.Continue();
    end;
    healHP();
    checkCombatState();

    if trainPrayer then
       buryBones();

    //if you are out of combat and the Mob is dead. Move to the next target
    if not isAttacking then
    begin
      Map.Walker.WalkBlind(anchorPt);
      lootItems();

      for i := 0 to 4 do
      begin
        writeln("["+timeElapsed+"]: "+"Looking for " + mobName + "'s position. Attempt: " + toStr(i));
        if i = 4 then
        begin
          Map.Walker.WalkBlind(anchorPt);
          Writeln("[" + timeElapsed +"]: " + "Could not find " + mobName +" , Walking to anchor coordinate: " + toStr(anchorPt));
          printProgReport();
        end;
        attackTarget();
        if isAttacking then
          break;
      end;
    end;
  end;
end;

begin
  init();
end.

